# MUD游戏网络版使用说明

## 概述

这是一个基于TCP协议的多人在线MUD武侠游戏，支持最多5个客户端同时连接。游戏采用场景限制系统，玩家需要在特定的场景中才能进行某些操作（如打怪、NPC对话、PK等），增加了游戏的策略性和沉浸感。玩家可以在不同的场景中探索、战斗、与NPC对话，体验丰富的武侠世界。

## 文档索引（建议先看）

- **游戏介绍（最终版）**：`GAME_INTRO.md`
- **类与函数说明（最终版）**：`CLASS_REFERENCE.md`
- **技术报告（论文格式）**：`TECHNICAL_REPORT.md` ← 含类图、时序图、数据结构（图）详解

## 功能特性

1. **多人在线游戏**：支持最多5个玩家同时在线
2. **角色系统**：可选择两种角色（萧言/莫），每个角色有独特的技能
3. **场景限制系统**：5个不同的游戏场景，每个场景有特定的功能限制
   - 不同场景允许不同的操作（如打怪、NPC对话、PK等）
   - 菜单会智能显示当前场景可用/不可用的操作
   - 尝试在不支持的场景进行操作会收到提示
4. **🆕 美化地图系统**：可视化地图，场景有明确的上下左右位置关系
   - 实时显示当前位置和可移动方向
   - 支持方向移动（n/s/e/w 或 上/下/左/右）
   - ASCII艺术风格的地图显示
5. **打怪升级**：与30种不同类型的怪物战斗获得经验，战斗结束后自动回血
6. **NPC对话**：与15个不同的NPC对话回答选择题获得经验奖励（支持选择题模式）
7. **玩家交互**：查看在线玩家列表、实时聊天系统
8. **玩家PK**：向其他在线玩家发起挑战进行PK战斗（支持状态锁定）
9. **存档系统**：使用JSON格式保存和加载角色数据
10. **🆕 武林秘籍修炼台**：共享资源系统，同时只能一人使用，通过答题获得属性提升或升级

## 文件说明

### 服务器端
- `NetworkGameServer.java` - 游戏服务器主程序
- `NetworkBattleSystem.java` - 网络版战斗系统（支持PVE和PVP）
- `JsonUtil.java` - JSON工具类，用于读写角色和NPC数据
- `Scene.java` - 场景类，定义游戏场景
- `npcs.json` - NPC对话数据配置文件（支持选择题）

### 客户端
- `NetworkGameClient.java` - 游戏客户端程序

### 其他核心文件
- `Figure.java` - 角色基类
- `Monster.java` - 怪物类
- `Npc.java` - NPC类（支持选择题）
- `Skill.java` - 技能类
- `XiaoYan.java` - 玩家角色类（萧言）
- `Mo.java` - 玩家角色类（莫）

## 使用方法

### 1. 编译项目

首先编译所有Java文件（包含Gson库）：
```bash
javac -encoding UTF-8 -cp "lib/gson-2.10.1.jar" -d out/production/USST src/com/mudgame/NetworkGameServer.java src/com/mudgame/NetworkGameClient.java src/com/mudgame/NetworkBattleSystem.java src/com/mudgame/JsonUtil.java src/com/mudgame/Figure.java src/com/mudgame/XiaoYan.java src/com/mudgame/Mo.java src/com/mudgame/Skill.java src/com/mudgame/Npc.java src/com/mudgame/Monster.java src/com/mudgame/Scene.java
```

### 2. 启动服务器

**方法一：使用启动脚本（推荐，解决中文乱码）**

**Windows CMD:**
```bash
start_server.bat
```

**Windows PowerShell:**
```bash
.\start_server.ps1
```

**方法二：手动启动**
```bash
# Windows
java -Dfile.encoding=UTF-8 -Dconsole.encoding=UTF-8 -cp "out/production/USST;lib/gson-2.10.1.jar" com.mudgame.NetworkGameServer

# Linux/Mac
java -Dfile.encoding=UTF-8 -Dconsole.encoding=UTF-8 -cp "out/production/USST:lib/gson-2.10.1.jar" com.mudgame.NetworkGameServer
```

服务器默认监听端口：**4444**

### 3. 启动客户端

在不同的终端或机器上运行客户端（最多5个）：

**方法一：使用启动脚本（推荐，解决中文乱码）**

**Windows CMD:**
```bash
# 连接本地服务器
start_client.bat

# 连接指定服务器
start_client.bat <服务器地址> <端口>
```

**Windows PowerShell:**
```bash
# 连接本地服务器
.\start_client.ps1

# 连接指定服务器
.\start_client.ps1 <服务器地址> <端口>
```

**方法二：手动启动**
```bash
# Windows - 连接本地服务器
java -Dfile.encoding=UTF-8 -Dconsole.encoding=UTF-8 -cp "out/production/USST;lib/gson-2.10.1.jar" com.mudgame.NetworkGameClient

# Windows - 连接指定服务器
java -Dfile.encoding=UTF-8 -Dconsole.encoding=UTF-8 -cp "out/production/USST;lib/gson-2.10.1.jar" com.mudgame.NetworkGameClient <服务器地址> <端口>

# Linux/Mac
java -Dfile.encoding=UTF-8 -Dconsole.encoding=UTF-8 -cp "out/production/USST:lib/gson-2.10.1.jar" com.mudgame.NetworkGameClient <服务器地址> <端口>
```

**注意：** 使用启动脚本可以自动设置UTF-8编码，解决中文乱码问题。如果手动启动，请确保添加 `-Dfile.encoding=UTF-8 -Dconsole.encoding=UTF-8` 参数。

### 4. 游戏操作

#### 角色选择

连接成功后，首先选择角色类型：
```
请选择角色类型:
1. 萧言 - 出生于蛇岛，擅长火系技能
2. 莫 - 出生于云山，擅长风系技能
请选择(1-2):
```

#### 主菜单

选择角色后，会显示当前场景地图和主菜单。菜单会根据当前场景智能显示可用/不可用的操作：

```
════════════════════════════════════════════════════════════════
**               新手村                     **
════════════════════════════════════════════════════════════════
**            宁静的村庄，适合新手修炼                  **
════════════════════════════════════════════════════════════════

当前位置: 新手村
场景描述: 宁静的村庄，适合新手修炼

===== 主菜单 =====
【当前场景可用操作】
1. 打怪练级 ✓
2. NPC对话 ✓
8. PK挑战 (pk <玩家名>) (当前场景不可用)

【通用操作】
3. 查看状态
4. 保存游戏
5. 加载游戏
6. 查看在线玩家
7. 聊天 (chat <消息> 或直接输入消息)
9. 切换场景
0. 退出游戏

请选择操作:
```

**注意**：菜单中带有 "✓" 标记的操作表示当前场景可用，标记为"(当前场景不可用)"的操作需要切换到对应场景才能使用。

**命令说明：**

- **输入 `1` 或 `battle`**：开始打怪
  - **场景限制**：只能在新手村、武林广场、练功房使用
  - 在其他场景会提示"当前场景不允许打怪！"
  - 战斗中使用 `11` 普通攻击，`12` 使用技能
  - 战斗结束后自动恢复满血

- **输入 `2` 或 `npc`**：与NPC对话
  - **场景限制**：只能在新手村、武林广场、藏经阁、江湖客栈使用
  - 在其他场景会提示"当前场景没有NPC可以对话！"
  - NPC会提出问题，以选择题形式回答
  - 选择正确的选项可获得经验奖励

- **输入 `3` 或 `status`**：查看角色状态
  - 显示角色等级、血量、攻击、防御、经验、技能等信息

- **输入 `4` 或 `save`**：保存游戏（JSON格式）
  - 角色数据会保存到服务器端

- **输入 `5` 或 `load`**：加载游戏
  - 从服务器端加载之前保存的角色数据

- **输入 `6` 或 `list`**：查看在线玩家列表
  - 显示所有在线玩家及其状态（PK中/战斗中/可挑战）

- **输入 `7 chat <消息>` 或直接输入消息**：聊天
  - 支持两种方式：`chat 消息内容` 或直接输入消息内容
  - 消息会广播给所有在线玩家，带时间戳

- **输入 `8 pk <玩家名>`**：向指定玩家发起PK挑战
  - **场景限制**：只能在武林广场使用
  - 在其他场景会提示"当前场景不允许PK！请切换到武林广场。"
  - 被挑战的玩家输入 `accept` 接受挑战
  - 被挑战的玩家输入 `reject` 拒绝挑战
  - PK中使用 `11` 普通攻击，`12` 使用技能
  - PK中的玩家无法被其他玩家挑战

- **输入 `9` 或 `scene`**：切换场景（🆕 v4.0 支持方向移动）
  - 显示可移动方向（上下左右）
  - 输入方向命令移动：`n/north/上/北`, `s/south/下/南`, `e/east/右/东`, `w/west/左/西`
  - 输入 `list` 查看所有场景列表
  - 输入 `map` 查看美化地图
  - 不同场景有不同的功能限制
  - 切换场景后，菜单会自动更新显示可用操作

- **输入 `10` 或 `train`**：使用武林秘籍修炼台（🆕 v3.0）
  - 全局共享资源，同时只能一人使用
  - 需要回答武学问题才能开启修炼
  - 成功后随机获得：经验值(+150)、攻击力(+3~7)、或防御力(+3~7)
  - 全局广播修炼状态，所有玩家可见
  - 菜单显示实时状态：[可用] 或 [使用中：玩家名]

- **输入 `0` 或 `quit`**：退出游戏

## 游戏场景

游戏包含5个不同的场景，每个场景有不同的特色和功能限制。**玩家必须在特定场景才能执行某些操作**：

### 场景详情

1. **新手村** - 宁静的村庄，适合新手修炼
   - ✓ 打怪练级
   - ✓ NPC对话
   - ✗ PK挑战（需前往武林广场）
   - 适合新手熟悉游戏基本操作

2. **武林广场** - 江湖人士聚集地，可以切磋武艺
   - ✓ 打怪练级
   - ✓ NPC对话
   - ✓ PK挑战（唯一可PK的场景）
   - 游戏中唯一可以进行玩家PK的场景

3. **藏经阁** - 存放武学秘籍的地方
   - ✗ 打怪练级（禁止打怪）
   - ✓ NPC对话（学习武学知识）
   - ✗ PK挑战（此处禁武）
   - 安静的学习场所，专注于NPC对话

4. **练功房** - 专门用于修炼的场所
   - ✓ 打怪练级（专注练级）
   - ✗ NPC对话（无NPC）
   - ✗ PK挑战（专注自我修炼）
   - 纯粹的练级场景，适合快速提升等级

5. **江湖客栈** - 休息和交流的地方
   - ✗ 打怪练级（此处禁武）
   - ✓ NPC对话（听江湖轶事）
   - ✗ PK挑战（此处禁武）
   - 社交场景，适合聊天和与NPC交流

### 场景切换

切换场景时会显示详细的场景列表：

```
════════════════════════════════════════════════════════
                    场景列表                    
════════════════════════════════════════════════════════

1. 【新手村】 [当前位置]
   描述: 宁静的村庄，适合新手修炼
   功能: 打怪练级、NPC对话

2. 【武林广场】
   描述: 江湖人士聚集地，可以切磋武艺
   功能: 打怪练级、NPC对话、PK挑战

3. 【藏经阁】
   描述: 存放武学秘籍的地方
   功能: NPC对话

4. 【练功房】
   描述: 专门用于修炼的场所
   功能: 打怪练级

5. 【江湖客栈】
   描述: 休息和交流的地方
   功能: NPC对话

════════════════════════════════════════════════════════
请选择要前往的场景(1-5):
```

## 战斗系统

### PVE战斗（打怪）

- 战斗中使用 `11` 进行普通攻击，`12` 使用技能
- 战斗结束后自动恢复满血
- 击败怪物可获得经验值

### PVP战斗（玩家PK）

- PK中使用 `11` 进行普通攻击，`12` 使用技能
- 只能输入 `11` 或 `12`，其他输入会提示错误
- PK中的玩家无法被其他玩家挑战
- 战斗中的玩家无法被挑战
- 获胜者获得50点经验奖励

## NPC对话系统

NPC对话采用选择题模式：

```
你遇到 NPC：书生
年轻人，你可知武学的真谛？

武林中最强的是什么？

请选择答案:
1. 心
2. 剑
3. 内功
4. 外功
请输入选项编号(1-4):
```

- 输入选项编号（1-4）即可回答
- 回答正确获得经验奖励
- NPC数据存储在 `npcs.json` 文件中

## 数据存储

### NPC数据（npcs.json）

NPC对话数据存储在 `src/com/mudgame/npcs.json` 文件中，格式如下：
```json
[
  {
    "id": 1,
    "name": "书生",
    "question": "武林中最强的是什么？",
    "answer": "心",
    "exp": 50,
    "dialogue": "年轻人，你可知武学的真谛？",
    "options": [
      "心",
      "剑",
      "内功",
      "外功"
    ]
  }
]
```

### 角色存档

每个玩家的存档保存在 `src/com/mudgame/save_<玩家名>.json` 文件中，使用JSON格式存储角色数据，包括角色类型（萧言/莫）。

## 游戏机制说明

### 场景限制系统

游戏采用**场景限制系统**，不同的操作只能在特定场景中执行：

- **打怪练级**：新手村、武林广场、练功房
- **NPC对话**：新手村、武林广场、藏经阁、江湖客栈
- **PK挑战**：仅限武林广场
- **通用操作**：所有场景都可用（查看状态、保存/加载、聊天等）

当你尝试在不支持的场景执行操作时，系统会提示你切换到合适的场景。

### 策略建议

- **新手**: 在新手村打怪和与NPC对话熟悉游戏
- **快速升级**: 前往练功房专注打怪练级
- **学习知识**: 在藏经阁与NPC对话获取经验
- **PK对战**: 前往武林广场与其他玩家切磋
- **社交娱乐**: 在江湖客栈聊天交流

## 网络协议

- **协议**：TCP
- **默认端口**：4444
- **最大连接数**：5个客户端
- **通信方式**：文本命令（一行一条命令）
- **编码**：UTF-8

## 注意事项

1. 确保服务器先启动，再启动客户端
2. 最多支持5个客户端同时连接
3. **场景限制**：不同操作只能在特定场景执行，尝试在不支持的场景操作会收到提示
4. PK战斗是回合制的，需要双方玩家依次操作
5. 游戏数据保存在服务器端的JSON文件中
6. 如果服务器关闭，所有客户端连接会断开
7. **中文乱码问题**：使用提供的启动脚本（`.bat` 或 `.ps1`）可以自动设置UTF-8编码，解决中文显示乱码问题
8. 如果使用命令行手动启动，请确保：
   - 添加 `-Dfile.encoding=UTF-8 -Dconsole.encoding=UTF-8` 参数
   - 在CMD中运行 `chcp 65001` 设置代码页为UTF-8
   - 在PowerShell中设置 `[Console]::OutputEncoding = [System.Text.Encoding]::UTF8`
9. **PK系统**：PK中只能输入 `11` 或 `12`，其他输入会提示错误
10. **状态锁定**：PK中或战斗中的玩家无法被其他玩家挑战
11. **自动回血**：每次战斗结束后自动恢复满血
12. **智能菜单**：主菜单会根据当前场景自动显示可用/不可用的操作

## 游戏特色

### 角色系统

- **萧言**：出生于蛇岛，擅长火系技能
  - 初始技能：火系突刺
  - 10级技能：水影步
  - 20级技能：蛇舞连击

- **莫**：出生于云山，擅长风系技能
  - 初始技能：风系突刺
  - 10级技能：云影步
  - 20级技能：风云连击

### 场景系统

- 5个不同的游戏场景
- 每个场景有不同的功能
- 可以随时切换场景
- 场景地图实时显示

### 聊天系统

- 支持两种聊天方式：`chat 消息` 或直接输入消息
- 消息带时间戳显示
- 发送者也能看到自己发送的消息

## 扩展功能

可以修改以下文件来扩展游戏功能：
- `npcs.json` - 添加更多NPC和问题
- `Scene.java` - 添加新场景
- `NetworkGameServer.java` - 修改场景初始化逻辑

## 更新日志

### 最新版本特性 (v4.0) - 2025-01-07

#### 🆕 美化地图系统
1. ✅ **可视化地图显示**：ASCII艺术风格的地图，实时显示当前位置
2. ✅ **方向移动系统**：支持上下左右方向移动（n/s/e/w 或 上/下/左/右）
3. ✅ **场景位置关系**：5个场景有明确的上下左右位置分布
4. ✅ **地图管理器**：管理场景节点、坐标和连接关系
5. ✅ **实时状态显示**：地图显示当前位置和可移动方向

### v3.0版本特性 - 2025-01-07

#### 🆕 武林秘籍修炼台系统
1. ✅ **共享资源机制**：全局唯一修炼台，同时只能一人使用
2. ✅ **问题答题系统**：回答武学问题才能开启修炼
3. ✅ **三种奖励类型**：
   - 30%概率：获得150经验（可能升级）
   - 35%概率：攻击力+3~7点（永久）
   - 35%概率：防御力+3~7点（永久）
4. ✅ **全局广播系统**：修炼开始/完成全服广播
5. ✅ **实时状态显示**：菜单显示修炼台可用状态

#### 🆕 NPC系统大幅扩展
6. ✅ **NPC数量提升**：从4个扩展到15个NPC
7. ✅ **多样化角色**：包括道士、医者、铁匠、酒仙、琴师、卦师等
8. ✅ **经验值范围**：65-150经验，更丰富的奖励

#### 🆕 怪物系统大幅扩展
9. ✅ **怪物数量提升**：从4种扩展到30种怪物
10. ✅ **等级分层系统**：普通(1-2级)、中级(2-4级)、高级(3-5级)、精英(4-6级)、Boss(5-7级)
11. ✅ **动态属性生成**：同名怪物每次属性不同，增加随机性
12. ✅ **智能经验分配**：经验值与怪物等级和难度成正比

### v2.0版本特性

#### 场景系统增强
1. ✅ **场景限制系统**：不同操作只能在特定场景执行
   - 打怪练级：新手村、武林广场、练功房
   - NPC对话：新手村、武林广场、藏经阁、江湖客栈
   - PK挑战：仅限武林广场
2. ✅ **智能菜单显示**：根据当前场景自动标记可用/不可用操作
3. ✅ **增强的场景切换界面**：显示每个场景的功能列表
4. ✅ **场景描述优化**：更清晰的场景介绍和功能说明

#### 之前版本特性
5. ✅ 战斗结束后自动回血
6. ✅ PK系统选项验证（只接受11和12）
7. ✅ NPC对话改为选择题模式
8. ✅ 场景系统，地图显示
9. ✅ 5个不同的游戏场景
10. ✅ 场景切换功能
11. ✅ 改进的聊天系统（支持直接输入消息）
12. ✅ PK状态锁定（防止PK中的玩家被挑战）
13. ✅ 玩家列表显示状态（PK中/战斗中/可挑战）

#### 改进内容
- 修复了场景系统的逻辑问题，现在场景限制正常工作
- 客户端默认连接localhost而非硬编码IP地址
- 最大客户端连接数从4增加到5

---

*最后更新：2025-01-07*
